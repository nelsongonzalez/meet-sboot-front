<!--
     @license
     Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
     This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
     The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
     The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
     Code distributed by Google as part of the polymer project is also
     subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
   -->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="shared-styles.html">

<dom-module id="my-new-event">
  <template>
    <style include="shared-styles">
     :host {
       display: block;

       padding: 10px;
     }

     div[slot=prefix] {
       color: var(--secondary-text-color);
     }

     paper-input[focused] div[slot=prefix] {
       color: var(--primary-color);
     }
    </style>

    <div class="card">
      <paper-input
          id="teamA"
          label="Equipo local"
          value="{{event.teamA}}"
          maxlength="30"
          required
          error-message="Ingrese un nombre"
          auto-validate></paper-input>

      <paper-input
          id="teamB"
          label="Equipo rival"
          value="{{event.teamB}}"
          maxlength="30"
          required
          error-message="Ingrese un nombre"
          auto-validate></paper-input>

      <paper-input
          id="amount"
          label="Monto para apuestas"
          value="{{event.amount}}"
          type="number"
          allowed-pattern="[0-9]"
          required
          min="1"
          max="500"
          error-message="Ingrese un nÃºmero entre 1 y 500"
          auto-validate>
        <div slot="prefix">$&nbsp;</div>
      </paper-input>

      <paper-button on-tap="_saveEvent" raised>Guardar</paper-button>
    </div>
  </template>

  <script>
   class MyNewEvent extends Polymer.Element {

     static get is() { return 'my-new-event'; }

     static get properties() {
       return {
         event: {
           type: Object,
           value: {}
         }
       };
     }

     _saveEvent() {
       if (this.$.teamA.invalid || this.$.teamB.invalid || this.$.amount.invalid) {
         return;
       }
       let user = firebase.app('meet-apuestas').auth().currentUser,
           newEventKey = firebase.app('meet-apuestas').database().ref().child('events').push().key,
           publicEvent,
           updates = {},
           onComplete = (error) => {
             if (error == null) {
               this.event = {};
               console.log('success!');
               window.history.pushState({}, null, '/events');
               window.dispatchEvent(new CustomEvent('location-changed'));
             } else {
               console.log(error);
             }
           };
       this.event.amount = parseInt(this.event.amount);
       this.event.status = 'new';
       publicEvent = JSON.parse(JSON.stringify(this.event));
       publicEvent.owner = user.uid;
       updates['/users/' + user.uid + '/events/' + newEventKey] = this.event;
       updates['/public/events/' + newEventKey] = publicEvent;
       firebase.app('meet-apuestas').database().ref()
               .update(updates, onComplete);
     }

   }

   // Register custom element definition using standard platform API
   customElements.define(MyNewEvent.is, MyNewEvent);
  </script>
</dom-module>
